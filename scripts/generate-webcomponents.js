// Generates .wc.svelte wrappers for components and updates src/webcomponents.ts
// Usage: node scripts/generate-webcomponents.js
import { promises as fs } from 'fs';
import path from 'path';

const root = path.resolve(path.dirname(new URL(import.meta.url).pathname), '..');
const srcDir = path.join(root, 'src');
const componentsDir = path.join(srcDir, 'components');

function toKebab(str) {
  return str
    .replace(/([a-z0-9])([A-Z])/g, '$1-$2')
    .replace(/\s+/g, '-')
    .toLowerCase();
}

async function fileExists(p) {
  try {
    await fs.access(p);
    return true;
  } catch {
    return false;
  }
}

async function generateWrapper(dirName) {
  const folderPath = path.join(componentsDir, dirName);
  const mainName = dirName; // assume main component matches folder
  const mainSvelte = path.join(folderPath, `${mainName}.svelte`);
  const wcSvelte = path.join(folderPath, `${mainName}.wc.svelte`);
  const typesTs = path.join(folderPath, 'types.ts');

  const hasMain = await fileExists(mainSvelte);
  if (!hasMain) return false; // skip if no main component

  const hasWrapper = await fileExists(wcSvelte);
  if (hasWrapper) return true; // already present

  const tag = `pf-${toKebab(mainName)}`;

  const hasTypes = await fileExists(typesTs);
  const scriptBlock = hasTypes
    ? `<script lang=\"ts\">\n  import ${mainName} from './${mainName}.svelte';\n  import type { ${mainName}Props } from './types';\n\n  let props: ${mainName}Props = $props();\n</script>`
    : `<script lang=\"ts\">\n  import ${mainName} from './${mainName}.svelte';\n\n  let props = $props();\n</script>`;

  const content = `<svelte:options customElement=\"${tag}\" />\n\n${scriptBlock}\n\n<${mainName} {...props}>\n  <slot />\n</${mainName}>\n`;

  await fs.writeFile(wcSvelte, content, 'utf8');
  return true;
}

async function updateEntryFile(imports) {
  const entryPath = path.join(srcDir, 'webcomponents.ts');
  const header = `// Web Components Entry Point\n// Auto-generated by scripts/generate-webcomponents.js\n\n`;
  const lines = imports
    .map((imp) => `import '${imp}';`)
    .join('\n');
  const footer = `\n// Note: Custom elements are registered via <svelte:options customElement> in each .wc.svelte`;
  const content = `${header}${lines}${footer}\n`;
  await fs.writeFile(entryPath, content, 'utf8');
}

async function main() {
  const entries = await fs.readdir(componentsDir, { withFileTypes: true });
  const componentDirs = entries.filter((e) => e.isDirectory()).map((e) => e.name);

  const imports = [];
  for (const dirName of componentDirs) {
    const created = await generateWrapper(dirName);
    const wcPath = path.join('src', 'components', dirName, `${dirName}.wc.svelte`);
    if (await fileExists(path.join(root, wcPath))) {
      imports.push(`./components/${dirName}/${dirName}.wc.svelte`);
    }
  }

  imports.sort();
  await updateEntryFile(imports);
  console.log(`Generated/verified wrappers for ${imports.length} components.`);
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});
